
let paintings=[],idx=0,user=''; let admin=false;
window.onload=async()=>{ const saved=localStorage.getItem('user'); if(saved){user=saved;nameModal.style.display='none';loadPaintings();}};
async function setName(){ user=username.value; if(!user)return; localStorage.setItem('user',user); nameModal.style.display='none'; loadPaintings(); }
async function loadPaintings(){ const r=await fetch('/api/paintings'); paintings=await r.json(); if(paintings.length===0)return; show(); }
function show(){ const p=paintings[idx]; if(!p)return; author.innerText=p.author; painting.src=p.imagePath; likeBtn.disabled=false; likeBtn.style.background=''; likeBtn.innerText='ã„ã„ã­'; }
async function like(){ const p=paintings[idx]; const r=await fetch('/api/like',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paintingId:p.id,userName:user})}); const d=await r.json(); if(d.ok){likeBtn.style.background='lightgreen';likeBtn.innerText='ã‚ã‚ŠãŒã¨ã†!';likeBtn.disabled=true;} }
function next(){ idx++; if(idx>=paintings.length){author.innerText='ã”æ¥å ´ã‚ã‚ŠãŒã¨ã†!'; painting.src='thanks.png'; likeBtn.style.display='none'; return;} likeBtn.style.display='inline-block'; show(); }
async function adminLogin(){ const r=await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:adminPass.value})}); if(r.ok){admin=true;document.querySelectorAll('.locked').forEach(b=>{b.classList.remove('locked');b.textContent=b.textContent.replace(' ğŸ”’','');}); loadList(); loadRank();} }
document.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('show'));btn.classList.add('active');document.getElementById(btn.dataset.tab).classList.add('show'); if(btn.dataset.tab==='listTab') loadList(); if(btn.dataset.tab==='rankTab') loadRank();}));
async function uploadPainting(){ const fd=new FormData(); fd.append('author',authorReg.value); fd.append('order',orderReg.value); fd.append('image',imageReg.files[0]); await fetch('/api/admin/paintings',{method:'POST',body:fd}); alert('ç™»éŒ²ã—ã¾ã—ãŸ'); loadList(); }
async function loadList(){ const r=await fetch('/api/paintings'); const data=await r.json(); list.innerHTML=data.map(x=>`<div><b>${x.order}. ${x.author}</b><br><img src="${x.imagePath}" width="120"><br><button onclick="editPainting('${x.id}')">ç·¨é›†</button><button onclick="deletePainting('${x.id}')">å‰Šé™¤</button></div><hr>`).join(''); }
async function editPainting(id){ const author=prompt('ä½œè€…'); const order=prompt('é †ç•ª'); const fd=new FormData(); fd.append('author',author); fd.append('order',order); await fetch('/api/admin/paintings/'+id,{method:'PUT',body:fd}); loadList(); }
async function deletePainting(id){ if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return; await fetch('/api/admin/paintings/'+id,{method:'DELETE'}); loadList(); }
async function loadRank(){ const r=await fetch('/api/admin/likes/ranking'); const data=await r.json(); rank.innerHTML=data.map(x=>`${x.order}. ${x.author} - ${x.likes} ã„ã„ã­`).join('<br>'); }
async function resetLikes(){ await fetch('/api/admin/likes/reset',{method:'DELETE'}); loadRank(); }
